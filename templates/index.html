{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">


                <!-- Connection Status -->
                <div class="mb-4">
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-info" id="testConnectionBtn">
                            <i class="fas fa-wifi me-2"></i>
                            Probar Conexión API
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="showTokenBtn">
                            <i class="fas fa-key me-2"></i>
                            Ver Token Actual
                        </button>
                        <button type="button" class="btn btn-outline-warning" id="resetConnectionBtn" style="display: none;">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            Cerrar Conexión
                        </button>
                    </div>
                    <div id="connectionStatus" class="mt-2"></div>
                    <div id="tokenInput" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Nuevo Token API:</strong> Introduce el nuevo token de Sesame para conectar con una cuenta diferente.
                        </div>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newTokenInput" placeholder="Introduce el nuevo token de Sesame API">
                            <button class="btn btn-success" type="button" id="applyTokenBtn">
                                <i class="fas fa-check me-2"></i>
                                Aplicar Token
                            </button>
                            <button class="btn btn-secondary" type="button" id="cancelTokenBtn">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Generation Form -->
                <form method="POST" action="{{ url_for('main.generate_report') }}" id="reportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_range" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Selector de fechas
                                </label>
                                <select class="form-select" id="date_range" name="date_range">
                                    <option value="today">Hoy</option>
                                    <option value="yesterday">Ayer</option>
                                    <option value="current_week">Semana actual</option>
                                    <option value="last_week">Semana pasada</option>
                                    <option value="current_month">Mes actual</option>
                                    <option value="last_month">Mes pasado</option>
                                    <option value="current_quarter">Trimestre actual</option>
                                    <option value="current_year">Año actual</option>
                                    <option value="last_year">Año pasado</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                                <div class="form-text">Seleccione un rango de fechas predefinido</div>
                            </div>
                        </div>
                        <div class="col-md-6" id="custom_date_range" style="display: none;">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="from_date" class="form-label">Fecha de Inicio</label>
                                        <input type="date" class="form-control" id="from_date" name="from_date">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="to_date" class="form-label">Fecha de Fin</label>
                                        <input type="date" class="form-control" id="to_date" name="to_date">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="report_type" class="form-label">
                            <i class="fas fa-chart-bar me-1"></i>
                            Tipo de informe
                        </label>
                        <select class="form-select" id="report_type" name="report_type">
                            <option value="by_employee">Grupos y tipos de fichaje por empleado</option>
                            <option value="by_type">Grupos y tipos de fichaje por tipo de fichaje</option>
                            <option value="by_group">Grupos y tipos de fichaje por grupos</option>
                        </select>
                        <div class="form-text">Seleccione el tipo de agrupación para el informe</div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="employee_id" class="form-label">
                                    <i class="fas fa-user me-1"></i>
                                    Empleado
                                </label>
                                <select class="form-select" id="employee_id" name="employee_id">
                                    <option value="">Todos los empleados</option>
                                </select>
                                <div class="form-text">Opcional: Seleccione un empleado específico o deje vacío para todos</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="office_id" class="form-label">
                                    <i class="fas fa-building me-1"></i>
                                    Centro
                                </label>
                                <select class="form-select" id="office_id" name="office_id">
                                    <option value="">Todos los centros</option>
                                </select>
                                <div class="form-text">Opcional: Seleccione un centro específico</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="department_id" class="form-label">
                                    <i class="fas fa-users me-1"></i>
                                    Departamento
                                </label>
                                <select class="form-select" id="department_id" name="department_id">
                                    <option value="">Todos los departamentos</option>
                                </select>
                                <div class="form-text">Opcional: Seleccione un departamento específico</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <i class="fas fa-file-excel me-2"></i>
                            Generar Reporte XLSX
                        </button>
                    </div>
                </form>

                <!-- Report Information -->
                <div class="mt-4">
                    <h5>Información del Reporte</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Columnas incluidas:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-user text-primary me-2"></i>Empleado</li>
                                <li><i class="fas fa-id-card text-primary me-2"></i>Tipo de Identificación</li>
                                <li><i class="fas fa-hashtag text-primary me-2"></i>Nº de Identificación</li>
                                <li><i class="fas fa-calendar text-primary me-2"></i>Fecha</li>
                                <li><i class="fas fa-tasks text-primary me-2"></i>Actividad</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Columnas adicionales:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-layer-group text-primary me-2"></i>Grupo</li>
                                <li><i class="fas fa-clock text-primary me-2"></i>Entrada</li>
                                <li><i class="fas fa-clock text-primary me-2"></i>Salida</li>
                                <li><i class="fas fa-stopwatch text-primary me-2"></i>Tiempo registrado</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Feature Highlight -->
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Característica especial:</strong> Los descansos de desayuno se incluyen automáticamente en las actividades adyacentes, asegurando que las 8 horas de trabajo se reflejen correctamente para la facturación.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mb-0">Generando reporte...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const showTokenBtn = document.getElementById('showTokenBtn');
    const resetConnectionBtn = document.getElementById('resetConnectionBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const tokenInput = document.getElementById('tokenInput');
    const newTokenInput = document.getElementById('newTokenInput');
    const applyTokenBtn = document.getElementById('applyTokenBtn');
    const cancelTokenBtn = document.getElementById('cancelTokenBtn');
    const employeeSelect = document.getElementById('employee_id');
    const officeSelect = document.getElementById('office_id');
    const departmentSelect = document.getElementById('department_id');
    const dateRangeSelect = document.getElementById('date_range');
    const customDateRange = document.getElementById('custom_date_range');
    const fromDateInput = document.getElementById('from_date');
    const toDateInput = document.getElementById('to_date');
    const reportForm = document.getElementById('reportForm');
    const generateBtn = document.getElementById('generateBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    // Handle date range selection
    dateRangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateRange.style.display = 'block';
        } else {
            customDateRange.style.display = 'none';
            // Clear custom date inputs when not using custom range
            fromDateInput.value = '';
            toDateInput.value = '';
        }
    });

    // Function to calculate date ranges
    function calculateDateRange(rangeType) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        switch (rangeType) {
            case 'today':
                return {
                    from: today.toISOString().split('T')[0],
                    to: today.toISOString().split('T')[0]
                };
            
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                return {
                    from: yesterday.toISOString().split('T')[0],
                    to: yesterday.toISOString().split('T')[0]
                };
            
            case 'current_week':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Monday
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
                return {
                    from: startOfWeek.toISOString().split('T')[0],
                    to: endOfWeek.toISOString().split('T')[0]
                };
            
            case 'last_week':
                const lastWeekStart = new Date(today);
                lastWeekStart.setDate(today.getDate() - today.getDay() - 6); // Last Monday
                const lastWeekEnd = new Date(lastWeekStart);
                lastWeekEnd.setDate(lastWeekStart.getDate() + 6); // Last Sunday
                return {
                    from: lastWeekStart.toISOString().split('T')[0],
                    to: lastWeekEnd.toISOString().split('T')[0]
                };
            
            case 'current_month':
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                return {
                    from: startOfMonth.toISOString().split('T')[0],
                    to: endOfMonth.toISOString().split('T')[0]
                };
            
            case 'last_month':
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                return {
                    from: lastMonthStart.toISOString().split('T')[0],
                    to: lastMonthEnd.toISOString().split('T')[0]
                };
            
            case 'current_quarter':
                const quarter = Math.floor(today.getMonth() / 3);
                const quarterStart = new Date(today.getFullYear(), quarter * 3, 1);
                const quarterEnd = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                return {
                    from: quarterStart.toISOString().split('T')[0],
                    to: quarterEnd.toISOString().split('T')[0]
                };
            
            case 'current_year':
                const yearStart = new Date(today.getFullYear(), 0, 1);
                const yearEnd = new Date(today.getFullYear(), 11, 31);
                return {
                    from: yearStart.toISOString().split('T')[0],
                    to: yearEnd.toISOString().split('T')[0]
                };
            
            case 'last_year':
                const lastYearStart = new Date(today.getFullYear() - 1, 0, 1);
                const lastYearEnd = new Date(today.getFullYear() - 1, 11, 31);
                return {
                    from: lastYearStart.toISOString().split('T')[0],
                    to: lastYearEnd.toISOString().split('T')[0]
                };
            
            default:
                return { from: '', to: '' };
        }
    }

    // Test connection
    testConnectionBtn.addEventListener('click', function() {
        testConnectionBtn.disabled = true;
        testConnectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Probando...';
        
        fetch('/test-connection')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    connectionStatus.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Conexión exitosa. Empresa: ${data.company}
                        </div>
                    `;
                    resetConnectionBtn.style.display = 'inline-block';
                    loadEmployees();
                    loadOffices();
                    loadDepartments();
                } else {
                    connectionStatus.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    resetConnectionBtn.style.display = 'none';
                }
            })
            .catch(error => {
                connectionStatus.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error de conexión: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                testConnectionBtn.disabled = false;
                testConnectionBtn.innerHTML = '<i class="fas fa-wifi me-2"></i>Probar Conexión API';
            });
    });

    // Show current token
    showTokenBtn.addEventListener('click', function() {
        showTokenBtn.disabled = true;
        showTokenBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Consultando...';
        
        fetch('/get-current-token')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    connectionStatus.innerHTML = `
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-key me-2"></i>
                            <strong>Token Actual:</strong> ${data.token_preview} (${data.token_length} caracteres)
                        </div>
                    `;
                } else {
                    connectionStatus.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                connectionStatus.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error al obtener información del token: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                showTokenBtn.disabled = false;
                showTokenBtn.innerHTML = '<i class="fas fa-key me-2"></i>Ver Token Actual';
            });
    });

    // Reset connection
    resetConnectionBtn.addEventListener('click', function() {
        resetConnectionBtn.disabled = true;
        connectionStatus.innerHTML = `
            <div class="alert alert-warning mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Conexión cerrada. Puedes introducir un nuevo token para conectar con otra cuenta.
            </div>
        `;
        resetConnectionBtn.style.display = 'none';
        tokenInput.style.display = 'block';
        employeeSelect.innerHTML = '<option value="">Todos los empleados</option>';
        officeSelect.innerHTML = '<option value="">Todos los centros</option>';
        departmentSelect.innerHTML = '<option value="">Todos los departamentos</option>';
        newTokenInput.value = '';
        newTokenInput.focus();
    });

    // Apply new token
    applyTokenBtn.addEventListener('click', function() {
        const newToken = newTokenInput.value.trim();
        if (!newToken) {
            alert('Por favor, introduce un token válido');
            return;
        }

        applyTokenBtn.disabled = true;
        applyTokenBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Aplicando...';

        fetch('/apply-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: newToken })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                connectionStatus.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Token aplicado correctamente. Empresa: ${data.company}
                    </div>
                `;
                tokenInput.style.display = 'none';
                resetConnectionBtn.style.display = 'inline-block';
                loadEmployees();
                loadOffices();
                loadDepartments();
            } else {
                connectionStatus.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error al aplicar el token: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            connectionStatus.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al conectar: ${error.message}
                </div>
            `;
        })
        .finally(() => {
            applyTokenBtn.disabled = false;
            applyTokenBtn.innerHTML = '<i class="fas fa-check me-2"></i>Aplicar Token';
        });
    });

    // Cancel token input
    cancelTokenBtn.addEventListener('click', function() {
        tokenInput.style.display = 'none';
        newTokenInput.value = '';
        connectionStatus.innerHTML = `
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Haz clic en "Probar Conexión API" para verificar la conexión actual.
            </div>
        `;
    });

    // Load employees
    function loadEmployees() {
        fetch('/get-employees')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    employeeSelect.innerHTML = '<option value="">Todos los empleados</option>';
                    data.employees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = employee.name;
                        employeeSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading employees:', error);
            });
    }

    // Load offices
    function loadOffices() {
        fetch('/get-offices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    officeSelect.innerHTML = '<option value="">Todos los centros</option>';
                    data.offices.forEach(office => {
                        const option = document.createElement('option');
                        option.value = office.id;
                        option.textContent = office.name;
                        officeSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading offices:', error);
            });
    }

    // Load departments
    function loadDepartments() {
        fetch('/get-departments')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    departmentSelect.innerHTML = '<option value="">Todos los departamentos</option>';
                    data.departments.forEach(department => {
                        const option = document.createElement('option');
                        option.value = department.id;
                        option.textContent = department.name;
                        departmentSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading departments:', error);
            });
    }

    // Form submission
    reportForm.addEventListener('submit', function(e) {
        // Process date range before submission
        const dateRange = dateRangeSelect.value;
        if (dateRange !== 'custom') {
            const dates = calculateDateRange(dateRange);
            fromDateInput.value = dates.from;
            toDateInput.value = dates.to;
        }
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
        loadingModal.show();

        // Reset button state after a delay (in case of errors)
        setTimeout(() => {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-file-excel me-2"></i>Generar Reporte XLSX';
            loadingModal.hide();
        }, 30000); // 30 seconds timeout
    });

    // Set default dates (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('from_date').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('to_date').value = today.toISOString().split('T')[0];

    // Auto-test connection on page load
    setTimeout(() => {
        testConnectionBtn.click();
    }, 1000);
});
</script>
{% endblock %}
