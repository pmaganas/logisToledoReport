{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6">
            <h1 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                <div class="w-3 h-3 rounded-full bg-gray-400 mr-3" id="connectionDot"></div>
                <i class="ti ti-settings mr-2"></i>
                Configuración de Conexión
            </h1>

            <!-- Connection Status -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-2 mb-3" id="connectionButtons">
                    <button type="button" class="inline-flex items-center h-8 px-4 text-sm font-medium text-indigo-600 bg-white border border-indigo-300 rounded-xl hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors" id="configureTokenBtn">
                        <i class="ti ti-settings text-base mr-2"></i>
                        Configurar Token API
                    </button>
                    <button type="button" class="inline-flex items-center h-8 px-4 text-sm font-medium text-blue-600 bg-white border border-blue-300 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" id="testConnectionBtn" style="display: none;">
                        <i class="ti ti-wifi text-base mr-2"></i>
                        Probar Conexión API
                    </button>
                    <button type="button" class="inline-flex items-center h-8 px-4 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors" id="showTokenBtn" style="display: none;">
                        <i class="ti ti-key text-base mr-2"></i>
                        Ver Token Actual
                    </button>
                    <button type="button" class="inline-flex items-center h-8 px-4 text-sm font-medium text-yellow-600 bg-white border border-yellow-300 rounded-xl hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors" id="resetConnectionBtn" style="display: none;">
                        <i class="ti ti-logout text-base mr-2"></i>
                        Cerrar Conexión
                    </button>
                </div>
                <div id="connectionStatus" class="mt-2">
                    <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-xl">
                        <i class="ti ti-info-circle text-yellow-600 mr-2"></i>
                        <p class="text-sm text-yellow-800">No hay token configurado. Haz clic en "Configurar Token API" para empezar.</p>
                    </div>
                </div>
                <div id="tokenInput" class="mt-4" style="display: none;">
                    <div class="flex items-center p-3 bg-blue-50 border border-blue-200 rounded-xl mb-4">
                        <i class="ti ti-info-circle text-blue-600 mr-2"></i>
                        <p class="text-sm text-blue-800"><strong>Configurar Token API:</strong> Introduce el token de Sesame para conectar con la API. El token se guardará de forma segura en la base de datos.</p>
                    </div>
                    <div class="mb-4">
                        <label for="regionSelect" class="block text-sm font-medium text-gray-700 mb-2">Región del API</label>
                        <select class="w-full h-8 px-3 text-sm border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" id="regionSelect">
                            <option value="eu1">Europa 1 (eu1)</option>
                            <option value="eu2">Europa 2 (eu2)</option>
                            <option value="eu3">Europa 3 (eu3)</option>
                            <option value="eu4">Europa 4 (eu4)</option>
                            <option value="eu5">Europa 5 (eu5)</option>
                            <option value="br1">Brasil 1 (br1)</option>
                            <option value="br2">Brasil 2 (br2)</option>
                            <option value="mx1">México 1 (mx1)</option>
                            <option value="demo1">Demo 1 (demo1)</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" class="flex-1 h-8 px-3 text-sm border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" id="newTokenInput" placeholder="Introduce el token de Sesame API">
                        <button class="inline-flex items-center h-8 px-4 text-sm font-medium text-white bg-green-600 rounded-xl hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors" type="button" id="applyTokenBtn">
                            <i class="ti ti-check text-base mr-2"></i>
                            Aplicar Token
                        </button>
                        <button class="inline-flex items-center h-8 px-4 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors" type="button" id="cancelTokenBtn">
                            <i class="ti ti-x text-base mr-2"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Token Information -->
            <div class="mt-6 bg-gray-50 rounded-xl p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Información del Token</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">Región</div>
                        <div class="text-sm text-gray-900" id="tokenRegion">-</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 mb-1">Último acceso</div>
                        <div class="text-sm text-gray-900" id="lastAccess">-</div>
                    </div>
                </div>
            </div>

            <!-- How to get token -->
            <div class="mt-6 bg-blue-50 rounded-xl p-4">
                <h3 class="text-sm font-medium text-blue-700 mb-3">¿Cómo obtener un token de API?</h3>
                <div class="text-sm text-blue-600">
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Inicia sesión en tu cuenta de Sesame</li>
                        <li>Ve a la sección de configuración de API</li>
                        <li>Genera un nuevo token de acceso</li>
                        <li>Copia el token y pégalo en el campo anterior</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const configureTokenBtn = document.getElementById('configureTokenBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const showTokenBtn = document.getElementById('showTokenBtn');
    const resetConnectionBtn = document.getElementById('resetConnectionBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const tokenInput = document.getElementById('tokenInput');
    const newTokenInput = document.getElementById('newTokenInput');
    const applyTokenBtn = document.getElementById('applyTokenBtn');
    const cancelTokenBtn = document.getElementById('cancelTokenBtn');
    const regionSelect = document.getElementById('regionSelect');
    const tokenRegion = document.getElementById('tokenRegion');
    const lastAccess = document.getElementById('lastAccess');

    // Check connection status on page load
    checkConnectionStatus();

    function checkConnectionStatus() {
        fetch('/get-current-token')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.has_token) {
                    updateConnectionStatus(true, data.company, data.region);
                } else {
                    updateConnectionStatus(false);
                }
            })
            .catch(error => {
                console.error('Error checking connection:', error);
                updateConnectionStatus(false);
            });
    }

    function updateConnectionStatus(connected, company = null, region = null, loading = false) {
        const connectionDot = document.getElementById('connectionDot');
        
        if (loading) {
            // Estado naranja: conectando/cargando
            connectionDot.className = 'w-3 h-3 rounded-full bg-orange-500 mr-3';
            connectionStatus.innerHTML = `
                <div class="flex items-center p-3 bg-orange-50 border border-orange-200 rounded-xl">
                    <i class="ti ti-loader animate-spin text-orange-600 mr-2"></i>
                    <p class="text-sm text-orange-800">
                        <strong>Probando conexión...</strong> Verificando comunicación con la API.
                    </p>
                </div>
            `;
        } else if (connected) {
            // Estado verde: conexión exitosa
            connectionDot.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
            connectionStatus.innerHTML = `
                <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-xl">
                    <i class="ti ti-check text-green-600 mr-2"></i>
                    <p class="text-sm text-green-800">
                        <strong>Conexión exitosa.</strong> 
                        ${company ? `Empresa: ${company}` : 'Empresa no identificada'}
                    </p>
                </div>
            `;
            
            if (region) {
                tokenRegion.textContent = region.toUpperCase();
                lastAccess.textContent = new Date().toLocaleString();
            }
            
            configureTokenBtn.style.display = 'none';
            testConnectionBtn.style.display = 'inline-flex';
            showTokenBtn.style.display = 'inline-flex';
            resetConnectionBtn.style.display = 'inline-flex';
        } else {
            // Estado rojo: error de conexión
            connectionDot.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
            connectionStatus.innerHTML = `
                <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-xl">
                    <i class="ti ti-x text-red-600 mr-2"></i>
                    <p class="text-sm text-red-800">No hay token configurado o error de conexión. Haz clic en "Configurar Token API" para empezar.</p>
                </div>
            `;
            
            tokenRegion.textContent = '-';
            lastAccess.textContent = '-';
            
            configureTokenBtn.style.display = 'inline-flex';
            testConnectionBtn.style.display = 'none';
            showTokenBtn.style.display = 'none';
            resetConnectionBtn.style.display = 'none';
        }
    }

    // Configure token button
    configureTokenBtn.addEventListener('click', function() {
        tokenInput.style.display = 'block';
        newTokenInput.focus();
    });

    // Cancel token button
    cancelTokenBtn.addEventListener('click', function() {
        tokenInput.style.display = 'none';
        newTokenInput.value = '';
    });

    // Apply token button
    applyTokenBtn.addEventListener('click', function() {
        const token = newTokenInput.value.trim();
        const region = regionSelect.value;
        
        if (!token) {
            alert('Por favor, introduce un token válido');
            return;
        }
        
        applyTokenBtn.disabled = true;
        applyTokenBtn.innerHTML = '<i class="ti ti-loader animate-spin text-base mr-2"></i>Aplicando...';
        
        // Mostrar estado de carga
        updateConnectionStatus(false, null, null, true);
        
        fetch('/apply-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: token,
                region: region
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateConnectionStatus(true, data.company, region);
                tokenInput.style.display = 'none';
                newTokenInput.value = '';
                alert('Token aplicado correctamente');
            } else {
                updateConnectionStatus(false);
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error applying token:', error);
            updateConnectionStatus(false);
            alert('Error al aplicar el token');
        })
        .finally(() => {
            applyTokenBtn.disabled = false;
            applyTokenBtn.innerHTML = '<i class="ti ti-check text-base mr-2"></i>Aplicar Token';
        });
    });

    // Test connection button
    testConnectionBtn.addEventListener('click', function() {
        testConnectionBtn.disabled = true;
        testConnectionBtn.innerHTML = '<i class="ti ti-loader animate-spin text-base mr-2"></i>Probando...';
        
        // Mostrar estado de carga
        updateConnectionStatus(false, null, null, true);
        
        fetch('/test-connection')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateConnectionStatus(true, data.company, data.region);
                    alert('Conexión exitosa');
                } else {
                    updateConnectionStatus(false);
                    alert('Error de conexión: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error testing connection:', error);
                updateConnectionStatus(false);
                alert('Error al probar la conexión');
            })
            .finally(() => {
                testConnectionBtn.disabled = false;
                testConnectionBtn.innerHTML = '<i class="ti ti-wifi text-base mr-2"></i>Probar Conexión API';
            });
    });

    // Show token button
    showTokenBtn.addEventListener('click', function() {
        fetch('/get-current-token')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.has_token) {
                    alert(`Token actual: ${data.masked_token}\nRegión: ${data.region}\nDescripción: ${data.description || 'Sin descripción'}`);
                } else {
                    alert('No hay token configurado');
                }
            })
            .catch(error => {
                console.error('Error getting token:', error);
                alert('Error al obtener información del token');
            });
    });

    // Reset connection button
    resetConnectionBtn.addEventListener('click', function() {
        if (confirm('¿Estás seguro de que quieres cerrar la conexión? Se eliminará el token actual.')) {
            // TODO: Implement reset connection
            alert('Función no implementada aún');
        }
    });
});
</script>
{% endblock %}