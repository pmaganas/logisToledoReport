<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Generador de Informe Grupos y tipos de fichaje{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Figtree Font -->
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-latest/icons-sprite.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/tabler-icons.min.css">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'figtree': ['Figtree', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="font-figtree bg-gray-50 h-full flex flex-col">
    <nav class="bg-white border-b border-gray-200 px-4 sm:px-6 lg:px-8">
        <div class="mx-auto max-w-7xl">
            <div class="flex h-16 items-center justify-between">
                <a href="{{ url_for('main.index') }}" class="flex items-center text-gray-900 hover:text-indigo-500 transition-colors">
                    <i class="ti ti-file-spreadsheet text-xl mr-2"></i>
                    <span class="text-lg font-semibold">Generador de Informe Grupos y tipos de fichaje</span>
                </a>
                
                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-4">
                    {% set current_page = request.endpoint %}
                    <a href="{{ url_for('main.index') }}" 
                       class="{% if current_page == 'main.index' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} px-3 py-2 rounded-md text-sm font-medium transition-colors border nav-link"
                       {% if current_page == 'main.index' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Generador de Reportes...')"{% endif %}
                       data-page="generator">
                        <i class="ti ti-plus mr-1"></i>
                        Generar Reporte
                    </a>
                    <a href="{{ url_for('main.downloads') }}" 
                       class="{% if current_page == 'main.downloads' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} px-3 py-2 rounded-md text-sm font-medium transition-colors border nav-link"
                       {% if current_page == 'main.downloads' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Descargas...')"{% endif %}
                       data-page="downloads">
                        <i class="ti ti-download mr-1"></i>
                        Descargas
                    </a>
                    <a href="{{ url_for('main.connection') }}" 
                       class="{% if current_page == 'main.connection' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} px-3 py-2 rounded-md text-sm font-medium transition-colors border nav-link"
                       {% if current_page == 'main.connection' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Configuración...')"{% endif %}
                       data-page="connection">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-gray-400 mr-2" id="navConnectionDot"></div>
                            <i class="ti ti-settings mr-1"></i>
                            Conexión
                        </div>
                    </a>
                    <a href="{{ url_for('main.logout') }}" 
                       class="text-red-600 hover:text-red-900 border-transparent hover:bg-red-50 cursor-pointer px-3 py-2 rounded-md text-sm font-medium transition-colors border">
                        <i class="ti ti-logout mr-1"></i>
                        Cerrar sesión
                    </a>
                </div>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="text-gray-500 hover:text-gray-600 focus:outline-none focus:text-gray-600" id="mobile-menu-button">
                        <i class="ti ti-menu-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div class="hidden md:hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="{{ url_for('main.index') }}" 
                       class="{% if current_page == 'main.index' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} block px-3 py-2 rounded-md text-base font-medium border nav-link-mobile"
                       {% if current_page == 'main.index' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Generador de Reportes...')"{% endif %}
                       data-page="generator">
                        <i class="ti ti-plus mr-1"></i>
                        Generar Reporte
                    </a>
                    <a href="{{ url_for('main.downloads') }}" 
                       class="{% if current_page == 'main.downloads' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} block px-3 py-2 rounded-md text-base font-medium border nav-link-mobile"
                       {% if current_page == 'main.downloads' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Descargas...')"{% endif %}
                       data-page="downloads">
                        <i class="ti ti-download mr-1"></i>
                        Descargas
                    </a>
                    <a href="{{ url_for('main.connection') }}" 
                       class="{% if current_page == 'main.connection' %}bg-indigo-100 text-indigo-700 border-indigo-300 cursor-not-allowed{% else %}text-gray-600 hover:text-gray-900 border-transparent hover:bg-gray-50 cursor-pointer{% endif %} block px-3 py-2 rounded-md text-base font-medium border nav-link-mobile"
                       {% if current_page == 'main.connection' %}onclick="event.preventDefault(); return false;"{% else %}onclick="showNavLoading('Cargando Configuración...')"{% endif %}
                       data-page="connection">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-gray-400 mr-2" id="navConnectionDotMobile"></div>
                            <i class="ti ti-settings mr-1"></i>
                            Conexión
                        </div>
                    </a>
                    <a href="{{ url_for('main.logout') }}" 
                       class="text-red-600 hover:text-red-900 border-transparent hover:bg-red-50 cursor-pointer block px-3 py-2 rounded-md text-base font-medium border">
                        <i class="ti ti-logout mr-1"></i>
                        Cerrar sesión
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="mx-4 sm:mx-14 lg:mx-30 mt-8 mb-24 flex-grow overflow-auto">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 rounded-xl border-l-4 {{ 'border-red-500 bg-red-50' if category == 'error' else 'border-blue-500 bg-blue-50' }} p-4">
                        <div class="flex items-center">
                            <i class="ti ti-{{ 'alert-circle text-red-500' if category == 'error' else 'info-circle text-blue-500' }} mr-2"></i>
                            <p class="text-sm {{ 'text-red-700' if category == 'error' else 'text-blue-700' }}">{{ message }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Navigation Loading Modal -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" id="navLoadingModal">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-sm text-gray-600" id="navLoadingText">Cargando página...</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2">
                    <div class="bg-indigo-600 h-2 rounded-full transition-all duration-1000" style="width: 0%" id="navProgressBar"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-auto bg-gray-800 py-8">
        <div class="mx-4 sm:mx-14 lg:mx-30 text-center">
            <p class="text-sm text-gray-300">© 2025 Generador de Informe Grupos y tipos de fichaje</p>
        </div>
    </footer>
    
    {% block scripts %}{% endblock %}
    
    <!-- Mobile menu toggle script -->
    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Check connection status for navigation indicator
        function updateNavConnectionStatus() {
            const navDot = document.getElementById('navConnectionDot');
            const navDotMobile = document.getElementById('navConnectionDotMobile');
            
            fetch('/get-current-token')
                .then(response => response.json())
                .then(data => {
                    let dotClass = 'w-2 h-2 rounded-full mr-2 ';
                    if (data.status === 'success' && data.has_token) {
                        // Connected - green
                        dotClass += 'bg-green-500';
                    } else {
                        // Not connected - red
                        dotClass += 'bg-red-500';
                    }
                    
                    if (navDot) navDot.className = dotClass;
                    if (navDotMobile) navDotMobile.className = dotClass;
                })
                .catch(error => {
                    // Error - red
                    const errorClass = 'w-2 h-2 rounded-full bg-red-500 mr-2';
                    if (navDot) navDot.className = errorClass;
                    if (navDotMobile) navDotMobile.className = errorClass;
                });
        }

        // Update navigation status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNavConnectionStatus();
            
            // Update every 30 seconds
            setInterval(updateNavConnectionStatus, 30000);
        });

        // Navigation loading functionality
        let navProgressInterval;
        
        function showNavLoading(message) {
            const modal = document.getElementById('navLoadingModal');
            const text = document.getElementById('navLoadingText');
            const progressBar = document.getElementById('navProgressBar');
            
            // Set loading text
            text.textContent = message;
            
            // Reset and start progress bar
            progressBar.style.width = '0%';
            modal.classList.remove('hidden');
            
            // Animate progress bar
            let progress = 0;
            navProgressInterval = setInterval(() => {
                progress += Math.random() * 30; // Random increment for realistic feel
                if (progress > 95) progress = 95; // Don't reach 100% until page loads
                progressBar.style.width = progress + '%';
            }, 150);
            
            // Hide after a maximum time (fallback)
            setTimeout(() => {
                hideNavLoading();
            }, 5000);
        }
        
        function hideNavLoading() {
            const modal = document.getElementById('navLoadingModal');
            const progressBar = document.getElementById('navProgressBar');
            
            // Complete progress bar
            progressBar.style.width = '100%';
            
            // Clear interval
            if (navProgressInterval) {
                clearInterval(navProgressInterval);
                navProgressInterval = null;
            }
            
            // Hide modal after a brief delay
            setTimeout(() => {
                modal.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 300);
        }
        
        // Hide loading when page loads
        window.addEventListener('load', function() {
            hideNavLoading();
        });
        
        // Hide loading when DOM content is loaded (faster)
        document.addEventListener('DOMContentLoaded', function() {
            hideNavLoading();
        });
        
        // Handle browser back/forward buttons
        window.addEventListener('pageshow', function() {
            hideNavLoading();
        });
    </script>
</body>
</html>
